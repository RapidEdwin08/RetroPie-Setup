#!/usr/bin/env bash

# This file is part of The RetroPie Project
#
# The RetroPie Project is the legal property of its developers, whose names are
# too numerous to list here. Please refer to the COPYRIGHT.md file distributed with this source.
#
# See the LICENSE.md file at the top-level directory of this distribution and
# at https://raw.githubusercontent.com/RetroPie/RetroPie-Setup/master/LICENSE.md
#

rp_module_id="ioquake3"
rp_module_desc="Quake 3 source port"
rp_module_licence="GPL2 https://github.com/ioquake/ioq3/blob/master/COPYING.txt"
rp_module_repo="git https://github.com/ioquake/ioq3 main"
rp_module_section="opt"
rp_module_flags="!videocore"

function depends_ioquake3() {
    getDepends cmake libsdl2-dev libgl1-mesa-dev
}

function sources_ioquake3() {
    gitPullOrClone
    # https://github.com/RetroPie/RetroPie-Setup/pull/4094
    echo 'I_ACKNOWLEDGE_THE_MAKEFILE_IS_DEPRECATED=1' >> "$md_build/Makefile"
}

function build_ioquake3() {
    cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
    cmake --build build --clean-first
    md_ret_require="$md_build/build/Release/ioquake3"
}

function install_ioquake3() {
    md_ret_files=(
        "build/Release/ioq3ded"
        "build/Release/ioquake3"
        "build/Release/renderer_opengl1.so"
        "build/Release/renderer_opengl2.so"
        "misc/quake3.svg"
        "misc/quake3-tango.png"
    )
}

function remove_ioquake3() {
    local shortcut_name
    shortcut_name="Quake III Arena"
    rm -f "/usr/share/applications/$shortcut_name.desktop"; rm -f "$home/Desktop/$shortcut_name.desktop"
    rm -f "$romdir/ports/$shortcut_name.sh"
}

function configure_ioquake3() {
    local launcher=("$md_inst/ioquake3")
    isPlatform "mesa" && launcher+=("+set cl_renderer opengl1")
    isPlatform "kms" && launcher+=("+set r_mode -1" "+set r_customwidth %XRES%" "+set r_customheight %YRES%" "+set r_swapInterval 1")

    addPort "$md_id" "quake3" "Quake III Arena" "${launcher[*]}"

    mkRomDir "ports/quake3"

    moveConfigDir "$md_inst/baseq3" "$romdir/ports/quake3"
    moveConfigDir "$home/.q3a" "$md_conf_root/quake3/ioquake3"
    mkUserDir "$md_conf_root/quake3/ioquake3/baseq3"

    cat >"$md_inst/q3config.cfg" << _EOF_
// generated by quake, do not modify
unbindall
bind TAB "+scores"
bind ENTER "+button2"
bind ESCAPE "togglemenu"
bind SPACE "+moveup"
bind + "sizeup"
bind - "sizedown"
bind / "weapnext"
bind 0 "weapon 10"
bind 1 "weapon 1"
bind 2 "weapon 2"
bind 3 "weapon 3"
bind 4 "weapon 4"
bind 5 "weapon 5"
bind 6 "weapon 6"
bind 7 "weapon 7"
bind 8 "weapon 8"
bind 9 "weapon 9"
bind = "sizeup"
bind [ "weapprev"
bind \ "+mlook"
bind ] "weapnext"
bind _ "sizedown"
bind \` "toggleconsole"
bind a "+moveleft"
bind c "+movedown"
bind d "+moveright"
bind s "+back"
bind t "messagemode"
bind w "+forward"
bind ~ "toggleconsole"
bind PAUSE "pause"
bind UPARROW "+forward"
bind DOWNARROW "+back"
bind LEFTARROW "+left"
bind RIGHTARROW "+right"
bind ALT "+strafe"
bind CTRL "+attack"
bind SHIFT "+speed"
bind DEL "+lookdown"
bind PGDN "+lookup"
bind END "centerview"
bind F1 "vote yes"
bind F2 "vote no"
bind F3 "ui_teamorders"
bind F11 "screenshot"
bind MOUSE1 "+attack"
bind MOUSE2 "+strafe"
bind MOUSE3 "+zoom"
bind MWHEELDOWN "weapnext"
bind MWHEELUP "weapprev"
bind PAD0_A "+moveup"
bind PAD0_B "centerview"
bind PAD0_X "+movedown"
bind PAD0_Y "+speed"
bind PAD0_LEFTSTICK_CLICK "+movedown"
bind PAD0_RIGHTSTICK_CLICK "centerview"
bind PAD0_LEFTSHOULDER "weapprev"
bind PAD0_RIGHTSHOULDER "weapnext"
bind PAD0_DPAD_UP "+button3"
bind PAD0_DPAD_DOWN "+button2"
bind PAD0_DPAD_LEFT "+scores"
bind PAD0_DPAD_RIGHT "+scores"
bind PAD0_LEFTSTICK_LEFT "+moveleft"
bind PAD0_LEFTSTICK_RIGHT "+moveright"
bind PAD0_LEFTSTICK_UP "+forward"
bind PAD0_LEFTSTICK_DOWN "+back"
bind PAD0_RIGHTSTICK_LEFT "+left"
bind PAD0_RIGHTSTICK_RIGHT "+right"
bind PAD0_RIGHTSTICK_UP "+lookup"
bind PAD0_RIGHTSTICK_DOWN "+lookdown"
bind PAD0_LEFTTRIGGER "+moveup"
bind PAD0_RIGHTTRIGGER "+attack"
seta com_hunkMegs "128"
seta com_altivec "0"
seta com_maxfps "85"
seta com_blood "1"
seta com_ansiColor "0"
seta com_maxfpsUnfocused "0"
seta com_maxfpsMinimized "0"
seta com_busyWait "0"
seta com_introplayed "1"
seta con_autochat "1"
seta vm_cgame "2"
seta vm_game "2"
seta vm_ui "2"
seta dmflags "0"
seta fraglimit "10"
seta timelimit "0"
seta sv_hostname "noname"
seta sv_maxclients "8"
seta sv_minRate "0"
seta sv_maxRate "0"
seta sv_dlRate "100"
seta sv_minPing "0"
seta sv_maxPing "0"
seta sv_floodProtect "1"
seta sv_dlURL ""
seta sv_master3 ""
seta sv_master4 ""
seta sv_master5 ""
seta sv_lanForceRate "1"
seta sv_strictAuth "1"
seta sv_banFile "serverbans.dat"
seta con_autoclear "1"
seta cl_timedemoLog ""
seta cl_autoRecordDemo "0"
seta cl_aviFrameRate "25"
seta cl_aviMotionJpeg "1"
seta cl_yawspeed "140"
seta cl_pitchspeed "140"
seta cl_maxpackets "30"
seta cl_packetdup "1"
seta cl_run "1"
seta sensitivity "5"
seta cl_mouseAccel "0"
seta cl_freelook "1"
seta cl_mouseAccelStyle "0"
seta cl_mouseAccelOffset "5"
seta cl_allowDownload "0"
seta r_inGameVideo "1"
seta cg_autoswitch "1"
seta m_pitch "0.022000"
seta m_yaw "0.022"
seta m_forward "0.25"
seta m_side "0.25"
seta m_filter "0"
seta j_pitch "0.022"
seta j_yaw "-0.022"
seta j_forward "-0.25"
seta j_side "0.25"
seta j_up "0"
seta j_pitch_axis "3"
seta j_yaw_axis "2"
seta j_forward_axis "1"
seta j_side_axis "0"
seta j_up_axis "4"
seta cl_maxPing "800"
seta cl_lanForcePackets "1"
seta cl_guidServerUniq "1"
seta cl_consoleKeys "~ \` 0x7e 0x60"
seta name "UnnamedPlayer"
seta rate "25000"
seta snaps "20"
seta model "sarge"
seta headmodel "sarge"
seta team_model "james"
seta team_headmodel "*james"
seta g_redTeam "Stroggs"
seta g_blueTeam "Pagans"
seta color1 "4"
seta color2 "5"
seta handicap "100"
seta sex "male"
seta cl_anonymous "0"
seta cg_predictItems "1"
seta cl_useMumble "0"
seta cl_mumbleScale "0.0254"
seta cl_voipGainDuringCapture "0.2"
seta cl_voipCaptureMult "2.0"
seta cl_voipUseVAD "0"
seta cl_voipVADThreshold "0.25"
seta cl_voipShowMeter "1"
seta cl_voip "1"
seta cl_cURLLib "libcurl.so.4"
seta cg_viewsize "100"
seta cg_stereoSeparation "0"
seta cl_renderer "opengl2"
seta r_allowExtensions "1"
seta r_ext_compressed_textures "0"
seta r_ext_multitexture "1"
seta r_ext_compiled_vertex_array "1"
seta r_ext_texture_env_add "1"
seta r_ext_framebuffer_object "1"
seta r_ext_texture_float "1"
seta r_ext_framebuffer_multisample "0"
seta r_arb_seamless_cube_map "0"
seta r_arb_vertex_array_object "1"
seta r_ext_direct_state_access "1"
seta r_ext_texture_filter_anisotropic "0"
seta r_ext_max_anisotropy "2"
seta r_picmip "1"
seta r_roundImagesDown "1"
seta r_detailtextures "1"
seta r_texturebits "0"
seta r_colorbits "0"
seta r_stencilbits "8"
seta r_depthbits "0"
seta r_ext_multisample "0"
seta r_overBrightBits "1"
seta r_ignorehwgamma "0"
seta r_mode "-2"
seta r_fullscreen "1"
seta r_noborder "0"
seta r_customwidth "1600"
seta r_customheight "1024"
seta r_customPixelAspect "1"
seta r_simpleMipMaps "1"
seta r_vertexLight "0"
seta r_subdivisions "4"
seta r_stereoEnabled "0"
seta r_greyscale "0"
seta r_hdr "1"
seta r_floatLightmap "0"
seta r_postProcess "1"
seta r_toneMap "1"
seta r_autoExposure "1"
seta r_depthPrepass "1"
seta r_ssao "0"
seta r_normalMapping "1"
seta r_specularMapping "1"
seta r_deluxeMapping "1"
seta r_parallaxMapping "0"
seta r_parallaxMapOffset "0"
seta r_parallaxMapShadows "0"
seta r_cubeMapping "0"
seta r_cubemapSize "128"
seta r_deluxeSpecular "0.3"
seta r_pbr "0"
seta r_baseNormalX "1.0"
seta r_baseNormalY "1.0"
seta r_baseParallax "0.05"
seta r_baseSpecular "0.04"
seta r_baseGloss "0.3"
seta r_glossType "1"
seta r_dlightMode "0"
seta r_pshadowDist "128"
seta r_mergeLightmaps "1"
seta r_imageUpsample "0"
seta r_imageUpsampleMaxSize "1024"
seta r_imageUpsampleType "1"
seta r_genNormalMaps "0"
seta r_drawSunRays "0"
seta r_sunlightMode "1"
seta r_sunShadows "1"
seta r_shadowFilter "1"
seta r_shadowBlur "0"
seta r_shadowMapSize "1024"
seta r_shadowCascadeZNear "8"
seta r_shadowCascadeZFar "1024"
seta r_shadowCascadeZBias "0"
seta r_ignoreDstAlpha "1"
seta r_lodCurveError "250"
seta r_lodbias "0"
seta r_flares "0"
seta r_zproj "64"
seta r_stereoSeparation "64"
seta r_ignoreGLErrors "1"
seta r_fastsky "0"
seta r_drawSun "0"
seta r_dynamiclight "1"
seta r_dlightBacks "1"
seta r_finish "0"
seta r_textureMode "GL_LINEAR_MIPMAP_LINEAR"
seta r_swapInterval "0"
seta r_gamma "1"
seta r_facePlaneCull "1"
seta r_railWidth "16"
seta r_railCoreWidth "6"
seta r_railSegmentLength "32"
seta r_anaglyphMode "0"
seta cg_shadows "1"
seta r_marksOnTriangleMeshes "0"
seta r_vaoCache "0"
seta r_aviMotionJpegQuality "90"
seta r_screenshotJpegQuality "90"
seta r_allowResize "0"
seta r_centerWindow "0"
seta r_preferOpenGLES "-1"
seta in_keyboardDebug "0"
seta in_mouse "1"
seta in_nograb "0"
seta in_joystick "1"
seta joy_threshold "0.150000"
seta s_volume "0.8"
seta s_musicvolume "0.25"
seta s_doppler "1"
seta s_muteWhenMinimized "0"
seta s_muteWhenUnfocused "0"
seta s_useOpenAL "1"
seta s_alPrecache "1"
seta s_alGain "1.0"
seta s_alSources "96"
seta s_alDopplerFactor "1.0"
seta s_alDopplerSpeed "9000"
seta s_alDriver "libopenal.so.1"
seta s_alInputDevice ""
seta s_alDevice ""
seta s_alCapture "1"
seta ui_ffa_fraglimit "20"
seta ui_ffa_timelimit "0"
seta ui_tourney_fraglimit "0"
seta ui_tourney_timelimit "15"
seta ui_team_fraglimit "0"
seta ui_team_timelimit "20"
seta ui_team_friendly "1"
seta ui_ctf_capturelimit "8"
seta ui_ctf_timelimit "30"
seta ui_ctf_friendly "0"
seta g_spScores1 ""
seta g_spScores2 ""
seta g_spScores3 ""
seta g_spScores4 ""
seta g_spScores5 ""
seta g_spAwards ""
seta g_spVideos ""
seta g_spSkill "2"
seta ui_browserMaster "0"
seta ui_browserGameType "0"
seta ui_browserSortKey "4"
seta ui_browserShowFull "1"
seta ui_browserShowEmpty "1"
seta cg_brassTime "2500"
seta cg_drawCrosshair "4"
seta cg_drawCrosshairNames "1"
seta cg_marks "1"
seta server1 ""
seta server2 ""
seta server3 ""
seta server4 ""
seta server5 ""
seta server6 ""
seta server7 ""
seta server8 ""
seta server9 ""
seta server10 ""
seta server11 ""
seta server12 ""
seta server13 ""
seta server14 ""
seta server15 ""
seta server16 ""
seta com_pipefile ""
seta net_enabled "3"
seta net_mcast6addr "ff04::696f:7175:616b:6533"
seta net_mcast6iface ""
seta net_socksEnabled "0"
seta net_socksServer ""
seta net_socksPort "1080"
seta net_socksUsername ""
seta net_socksPassword ""
seta cm_playerCurveClip "1"
seta g_maxGameClients "0"
seta capturelimit "8"
seta g_friendlyFire "0"
seta g_teamAutoJoin "0"
seta g_teamForceBalance "0"
seta g_warmup "20"
seta g_log "games.log"
seta g_logSync "0"
seta g_banIPs ""
seta g_filterBan "1"
seta g_allowVote "1"
seta cg_drawGun "1"
seta cg_zoomfov "22.5"
seta cg_fov "90"
seta cg_gibs "1"
seta cg_draw2D "1"
seta cg_drawStatus "1"
seta cg_drawTimer "0"
seta cg_drawFPS "0"
seta cg_drawSnapshot "0"
seta cg_draw3dIcons "1"
seta cg_drawIcons "1"
seta cg_drawAmmoWarning "1"
seta cg_drawAttacker "1"
seta cg_drawRewards "1"
seta cg_crosshairSize "24"
seta cg_crosshairHealth "1"
seta cg_crosshairX "0"
seta cg_crosshairY "0"
seta cg_simpleItems "0"
seta cg_lagometer "1"
seta cg_railTrailTime "400"
seta cg_runpitch "0.002"
seta cg_runroll "0.005"
seta cg_bobpitch "0.002"
seta cg_bobroll "0.002"
seta cg_teamChatTime "3000"
seta cg_teamChatHeight "0"
seta cg_forceModel "0"
seta cg_deferPlayers "1"
seta cg_drawTeamOverlay "0"
seta cg_drawFriend "1"
seta cg_teamChatsOnly "0"
seta cg_noVoiceChats "0"
seta cg_noVoiceText "0"
seta cg_cameraOrbitDelay "50"
seta cg_scorePlums "1"
seta cg_smoothClients "0"
seta cg_noTaunt "0"
seta cg_noProjectileTrail "0"
seta ui_smallFont "0.25"
seta ui_bigFont "0.4"
seta cg_oldRail "1"
seta cg_oldRocket "1"
seta cg_oldPlasma "1"
seta cg_trueLightning "0.0"
seta in_joystickNo "0"
seta in_joystickUseAnalog "0"
seta com_zoneMegs "24"
_EOF_
    if [[ ! -f "$md_conf_root/quake3/ioquake3/baseq3/q3config.cfg" ]]; then cp "$md_inst/q3config.cfg" "$md_conf_root/quake3/ioquake3/baseq3/q3config.cfg"; fi
    sed -i s+seta\ in_joystick.*+seta\ in_joystick\ \"1\"+ "$md_conf_root/quake3/ioquake3/baseq3/q3config.cfg"
    chown $__user:$__user "$md_conf_root/quake3/ioquake3/baseq3/q3config.cfg"

    [[ "$md_mode" == "install" ]] && game_data_quake3
    [[ "$md_mode" == "install" ]] && shortcuts_icons_ioquake3
    [[ "$md_mode" == "remove" ]] && remove_ioquake3
}

function shortcuts_icons_ioquake3() {
    local shortcut_name
    shortcut_name="Quake III Arena"
    cat >"$md_inst/$shortcut_name.desktop" << _EOF_
[Desktop Entry]
Name=$shortcut_name
GenericName=$shortcut_name
Comment=$shortcut_name
Exec=$md_inst/ioquake3
Icon=$md_inst/quake3.svg
Terminal=false
Type=Application
Categories=Game;Emulator
Keywords=Q3;QuakeIII;Arena
StartupWMClass=QuakeIIIArena
Name[en_US]=$shortcut_name
_EOF_
    chmod 755 "$md_inst/$shortcut_name.desktop"
    if [[ -d "$home/Desktop" ]]; then rm -f "$home/Desktop/$shortcut_name.desktop"; cp "$md_inst/$shortcut_name.desktop" "$home/Desktop/$shortcut_name.desktop"; chown $__user:$__user "$home/Desktop/$shortcut_name.desktop"; fi
    rm -f "/usr/share/applications/$shortcut_name.desktop"; cp "$md_inst/$shortcut_name.desktop" "/usr/share/applications/$shortcut_name.desktop"; chown $__user:$__user "/usr/share/applications/$shortcut_name.desktop"
}
